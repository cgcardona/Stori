# ============================================================================
# Stori DAW — PR Test Pipeline
# ============================================================================
# Runs on every pull request to main/develop branches.
# Fast path: unit tests + integration tests + UI smoke suite + small audio regression.
# Designed to complete in <10 minutes on a macOS runner.
#
# Requirements:
#   - macOS runner with Xcode 26+ installed
#   - Self-hosted Mac mini recommended for audio tests (GitHub-hosted has no audio device)
# ============================================================================

name: PR Tests

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
  SCHEME: Stori
  PROJECT: Stori.xcodeproj
  DESTINATION: 'platform=macOS'

jobs:
  # ──────────────────────────────────────────────────────────────────────────
  # Job 1: Unit + Integration Tests
  # ──────────────────────────────────────────────────────────────────────────
  unit-tests:
    name: Unit & Integration Tests
    runs-on: macos-15
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Build for Testing
        run: |
          xcodebuild build-for-testing \
            -project ${{ env.PROJECT }} \
            -scheme ${{ env.SCHEME }} \
            -destination '${{ env.DESTINATION }}' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty --color || true

      - name: Run Unit Tests
        run: |
          xcodebuild test-without-building \
            -project ${{ env.PROJECT }} \
            -scheme ${{ env.SCHEME }} \
            -destination '${{ env.DESTINATION }}' \
            -resultBundlePath TestResults/UnitTests.xcresult \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            2>&1 | tee test-output.log | xcpretty --color || true

          # Check for test failures
          if grep -q "TEST FAILED" test-output.log 2>/dev/null; then
            echo "::error::Unit tests failed"
            exit 1
          fi
          if grep -q "xcodebuild: error:" test-output.log 2>/dev/null; then
            echo "::error::Build error during tests"
            exit 1
          fi

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: TestResults/
          retention-days: 7

      - name: Upload Test Log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-log
          path: test-output.log
          retention-days: 7

  # ──────────────────────────────────────────────────────────────────────────
  # Job 2: UI Smoke Tests
  # ──────────────────────────────────────────────────────────────────────────
  ui-smoke-tests:
    name: UI Smoke Tests
    runs-on: macos-15
    timeout-minutes: 20
    needs: unit-tests  # Only run if unit tests pass

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Build App for UI Testing
        run: |
          xcodebuild build-for-testing \
            -project ${{ env.PROJECT }} \
            -scheme ${{ env.SCHEME }} \
            -destination '${{ env.DESTINATION }}' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty --color || true

      - name: Run UI Smoke Tests
        run: |
          xcodebuild test-without-building \
            -project ${{ env.PROJECT }} \
            -scheme ${{ env.SCHEME }} \
            -destination '${{ env.DESTINATION }}' \
            -only-testing:StoriUITests \
            -resultBundlePath TestResults/UITests.xcresult \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            2>&1 | tee ui-test-output.log | xcpretty --color || true

          if grep -q "TEST FAILED" ui-test-output.log 2>/dev/null; then
            echo "::error::UI smoke tests failed"
            exit 1
          fi

      - name: Extract Screenshots from Results
        if: failure()
        run: |
          # Extract test attachments (screenshots) from xcresult bundle
          if [ -d "TestResults/UITests.xcresult" ]; then
            xcrun xcresulttool get --format json \
              --path TestResults/UITests.xcresult \
              > test-results.json 2>/dev/null || true
          fi

      - name: Upload UI Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-results
          path: |
            TestResults/
            ui-test-output.log
          retention-days: 14

  # ──────────────────────────────────────────────────────────────────────────
  # Job 3: Audio Regression (Small Set)
  # ──────────────────────────────────────────────────────────────────────────
  audio-regression:
    name: Audio Regression (PR)
    runs-on: macos-15
    timeout-minutes: 15
    needs: unit-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Run Audio Regression Tests
        run: |
          xcodebuild test \
            -project ${{ env.PROJECT }} \
            -scheme ${{ env.SCHEME }} \
            -destination '${{ env.DESTINATION }}' \
            -only-testing:StoriTests/SilenceDetectionTests \
            -only-testing:StoriTests/GoldenFileRegressionTests \
            -resultBundlePath TestResults/AudioRegression.xcresult \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            SRCROOT="${{ github.workspace }}" \
            2>&1 | tee audio-test-output.log | xcpretty --color || true

          if grep -q "TEST FAILED" audio-test-output.log 2>/dev/null; then
            echo "::error::Audio regression tests failed"
            exit 1
          fi

      - name: Upload Audio Test Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: audio-regression-artifacts
          path: |
            TestResults/
            audio-test-output.log
          retention-days: 14
